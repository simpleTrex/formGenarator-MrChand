<div class="domain-container">
  <!-- Header Section -->
  <div class="page-actions">
    <button class="back-btn" (click)="goBackToAdaptive()">← AdaptiveBP</button>
    <button class="back-btn" *ngIf="(isDomainUser() || isOwnerContext()) && mode !== 'PREVIEW'" (click)="enterPreviewMode()">Preview Mode</button>
    <button class="back-btn" *ngIf="(isDomainUser() || isOwnerContext()) && canEditMode && mode !== 'EDIT'" (click)="enterEditMode()">Edit Mode</button>
    <button class="back-btn" *ngIf="(isDomainUser() || isOwnerContext()) && canAccessManager && mode !== 'ACCESS'" (click)="enterAccessManagerMode()">Access Manager</button>
    <button class="back-btn" *ngIf="auth.isLoggedIn()" (click)="logout()">Logout</button>
  </div>

  <!-- Domain Info Section -->
  <div class="domain-info-section">
    <h2>Domain Information</h2>
    <div *ngIf="error" class="error-text">{{ error }}</div>
    <div *ngIf="domain" class="domain-details">
      <p><strong>Name:</strong> {{ domain.name }}</p>
      <p><strong>Slug:</strong> {{ domain.slug }}</p>
      <p *ngIf="domain.description"><strong>Description:</strong> {{ domain.description }}</p>
      <p *ngIf="domain.industry"><strong>Industry:</strong> {{ domain.industry }}</p>
    </div>
  </div>

  <div *ngIf="isDomainUser() || isOwnerContext(); else domainAuthForms">
    <!-- Preview Mode (default for all users) -->
    <div *ngIf="mode === 'PREVIEW'" class="card" style="margin-top: 12px;">
      <h3>Home</h3>
      <p class="info-text">
        This is the domain home page (business landing). We can customize this later.
      </p>
      <p class="info-text" *ngIf="canEditMode">
        You can switch to <strong>Edit Mode</strong> to create apps.
      </p>
      <p class="info-text" *ngIf="canAccessManager">
        You can manage users/groups using <strong>Access Manager</strong>.
      </p>
    </div>

    <div class="card" style="margin-top: 12px;" *ngIf="canUseApps || canManageApps">
      <h3>Applications</h3>
      <div *ngIf="appsLoading">Loading applications...</div>
      <div *ngIf="appError" class="error-text">{{ appError }}</div>
      <div *ngIf="apps && apps.length === 0 && !appsLoading" class="info-text">No applications yet.</div>
      <div class="app-list" *ngIf="apps && apps.length > 0">
        <div class="app-card" *ngFor="let app of apps" [routerLink]="['/domain', slug, 'app', app.slug]" style="cursor: pointer;">
          <div><strong>{{ app.name }}</strong> ({{ app.slug }})</div>
          <div *ngIf="app.ownerUserId">Owner: {{ app.ownerUserId }}</div>
        </div>
      </div>
    </div>

    <!-- Edit Mode (contributors/admins/owners) -->
    <div *ngIf="mode === 'EDIT'" class="card" style="margin-top: 12px;">
      <h3>Edit Mode</h3>
      <p class="info-text">Editor tools will appear here. For now: create applications.</p>

      <button class="btn" *ngIf="canManageApps" (click)="toggleCreateAppForm()">
        {{ showCreateAppForm ? 'Hide Create App' : 'Create App' }}
      </button>

      <div class="app-create" *ngIf="canManageApps && showCreateAppForm">
        <input type="text" placeholder="App name" [(ngModel)]="newApp.name" [ngModelOptions]="{standalone:true}">
        <input type="text" placeholder="Slug" [(ngModel)]="newApp.slug" [ngModelOptions]="{standalone:true}">
        <input type="text" placeholder="Owner User ID (optional)" [(ngModel)]="newApp.ownerUserId" [ngModelOptions]="{standalone:true}">
        <button (click)="submitNewApp()">Create App</button>
      </div>

      <div *ngIf="appMessage" class="success-text">{{ appMessage }}</div>
      <div *ngIf="appError" class="error-text">{{ appError }}</div>
    </div>

    <!-- Access Manager (admins/owners) -->
    <div *ngIf="mode === 'ACCESS' && canManageUsers" class="card" style="margin-top: 12px;">
      <h3>Domain Groups & Users</h3>
      <p class="info-text">Drag and drop users to assign them to groups</p>
      <div *ngIf="domainGroupsLoading || usersLoading">Loading...</div>
      <div *ngIf="groupError" class="error-text">{{ groupError }}</div>

      <div class="groups-users-container">
        <div class="groups-grid">
          <div *ngFor="let group of domainGroups" class="group-card"
               (dragover)="onDragOver($event)"
               (drop)="onDrop($event, group.id)">
            <div class="group-card-header">
              <strong>{{ group.name }}</strong>
              <span class="badge">{{ getUsersInGroup(group.id).length }} member(s)</span>
            </div>
            <div class="group-permissions">
              <span class="chip" *ngFor="let perm of group.permissions">{{ perm }}</span>
            </div>
            <div class="group-members">
              <div *ngIf="getUsersInGroup(group.id).length === 0" class="empty-message">
                Drop users here to add them
              </div>
              <div *ngFor="let user of getUsersInGroup(group.id)"
                   class="user-item"
                   draggable="true"
                   (dragstart)="onDragStart($event, user, group.id)"
                   (dragend)="onDragEnd()">
                <div class="user-info">
                  <strong>{{ user.username }}</strong>
                  <small>{{ user.email }}</small>
                </div>
                <button class="btn-remove" (click)="removeUserFromGroup(user, group.id)" title="Remove">×</button>
              </div>
            </div>
          </div>
        </div>

        <div class="unassigned-panel">
          <div class="panel-header">
            <strong>Unassigned Users</strong>
            <span class="badge">{{ getUsersWithoutGroups().length }}</span>
          </div>
          <div class="unassigned-list">
            <div *ngIf="getUsersWithoutGroups().length === 0" class="empty-message">
              All users are assigned
            </div>
            <div *ngFor="let user of getUsersWithoutGroups()"
                 class="user-item"
                 draggable="true"
                 (dragstart)="onDragStart($event, user, null)"
                 (dragend)="onDragEnd()">
              <div class="user-info">
                <strong>{{ user.username }}</strong>
                <small>{{ user.email }}</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <ng-template #domainAuthForms>
    <div class="auth-forms">
      <div class="card">
        <h3>Domain Login</h3>
        <form [formGroup]="loginForm" (ngSubmit)="submitLogin()">
          <label>Username
            <input type="text" formControlName="username" [class.invalid]="submittedLogin && lf['username'].errors">
          </label>
          <div *ngIf="submittedLogin && lf['username'].errors" class="error-text">Username is required</div>

          <label>Password
            <input type="password" formControlName="password" [class.invalid]="submittedLogin && lf['password'].errors">
          </label>
          <div *ngIf="submittedLogin && lf['password'].errors" class="error-text">Password is required</div>

          <button [disabled]="loadingLogin">Login</button>
          <div *ngIf="loginError" class="error-text">{{ loginError }}</div>
        </form>
      </div>

      <div class="card">
        <h3>Sign Up</h3>
        <form [formGroup]="signupForm" (ngSubmit)="submitSignup()">
          <label>Username
            <input type="text" formControlName="username" [class.invalid]="submittedSignup && sf['username'].errors">
          </label>
          <div *ngIf="submittedSignup && sf['username'].errors" class="error-text">Username is required</div>

          <label>Email
            <input type="email" formControlName="email" [class.invalid]="submittedSignup && sf['email'].errors">
          </label>
          <div *ngIf="submittedSignup && sf['email'].errors" class="error-text">
            <div *ngIf="sf['email'].errors['required']">Email is required</div>
            <div *ngIf="sf['email'].errors['email']">Invalid email</div>
          </div>

          <label>Password
            <input type="password" formControlName="password" [class.invalid]="submittedSignup && sf['password'].errors">
          </label>
          <div *ngIf="submittedSignup && sf['password'].errors" class="error-text">
            <div *ngIf="sf['password'].errors['required']">Password is required</div>
            <div *ngIf="sf['password'].errors['minlength']">At least 6 characters</div>
          </div>

          <button [disabled]="loadingSignup">Create account</button>
          <div *ngIf="signupError" class="error-text">{{ signupError }}</div>
          <div *ngIf="signupMessage" class="success-text">{{ signupMessage }}</div>
        </form>
      </div>
    </div>
  </ng-template>

</div>
